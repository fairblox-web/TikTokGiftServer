from flask import Flask, request, jsonify
import sys

# ‡∏™‡∏£‡πâ‡∏≤‡∏á Flask app
app = Flask(__name__)

# ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ô‡∏µ‡πâ
latest_gifts = []


# ------------------------------------------------------------
# üì¶ Route: ‡∏£‡∏±‡∏ö Webhook ‡∏à‡∏≤‡∏Å TikFinity
# ------------------------------------------------------------
@app.route("/tiktok-event", methods=["POST"])
def tiktok_event():
    global latest_gifts

    # ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô JSON ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if request.is_json:
        data = request.get_json()
    else:
        data = request.form.to_dict()

    # ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Log ‡∏Ç‡∏≠‡∏á Render
    print("üéÅ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç:", data)
    sys.stdout.flush()  # üî• ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ Render ‡πÅ‡∏™‡∏î‡∏á Log ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ

    # ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡πÑ‡∏ß‡πâ‡πÉ‡∏ô memory
    latest_gifts.append(data)

    # ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÉ‡∏´‡πâ TikFinity ‡∏ß‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
    return jsonify({"status": "ok"})


# ------------------------------------------------------------
# üì§ Route: ‡πÉ‡∏´‡πâ Roblox ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
# ------------------------------------------------------------
@app.route("/get-latest-gifts", methods=["GET"])
def get_latest_gifts():
    global latest_gifts
    gifts_to_send = latest_gifts
    latest_gifts = []  # ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏á‡∏™‡πà‡∏á
    return jsonify(gifts_to_send)


# ------------------------------------------------------------
# üßπ Route: ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡∏î‡∏µ‡∏ö‡∏±‡πä‡∏Å)
# ------------------------------------------------------------
@app.route("/clear-gifts", methods=["POST"])
def clear_gifts():
    global latest_gifts
    latest_gifts = []
    print("üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß")
    sys.stdout.flush()
    return jsonify({"status": "cleared"})


# ------------------------------------------------------------
# üè† Route: ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
# ------------------------------------------------------------
@app.route("/")
def home():
    return "‚úÖ TikTok Gift Server is running!"


# ------------------------------------------------------------
# üöÄ Run Flask Server (Render ‡πÉ‡∏ä‡πâ‡∏û‡∏≠‡∏£‡πå‡∏ï 3000)
# ------------------------------------------------------------
if __name__ == "__main__":
    app.run(host="0.0.0.0", port=3000)
